<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Medical Image Processing: Working with MRI</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicons/incubator/favicon-16x16.png"><link rel="manifest" href="favicons/incubator/site.webmanifest"><link rel="mask-icon" href="favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><span class="badge text-bg-warning">
          <abbr title="This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#field-testing-alpha-stage" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-triangle" style="border-radius: 5px"></i>
              Alpha
            </a>
            <span class="visually-hidden">This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/mri.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Medical Image Processing
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Medical Image Processing
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Glossary</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Medical Image Processing
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 13%" class="percentage">
    13%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 13%" aria-valuenow="13" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/mri.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. Course Introduction</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="medical_imaging.html">2. Medical Imaging Modalities</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        3. Working with MRI
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#introduction">Introduction</a></li>
<li><a href="#file-formats">File formats</a></li>
<li><a href="#libraries">Libraries</a></li>
<li><a href="#display-conventions">Display conventions</a></li>
<li><a href="#mri-processing-in-python">MRI processing in Python</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="simpleitk.html">4. Registration and Segmentation with SITK</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="images_ml.html">5. Preparing Images for Machine Learning</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="anonymization.html">6. Anonymizing Medical Images</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="generative_ai.html">7. Generative AI in Medical Imaging</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Glossary</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="medical_imaging.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="simpleitk.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="medical_imaging.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Medical Imaging
        </a>
        <a class="chapter-link float-end" href="simpleitk.html" rel="next">
          Next: Registration and...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Working with MRI</h1>
        <p>Last updated on 2024-12-29 |

        <a href="https://github.com/esciencecenter-digital-skills/medical-image-processing/edit/main/episodes/mri.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>What kinds of MRI are there?</li>
<li>How are MRI data represented digitally?</li>
<li>How should I organize and structure files for neuroimaging MRI
data?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Mention common kinds of MRI imaging used in research</li>
<li>Show the most common file formats for MRI</li>
<li>Introduce MRI coordinate systems</li>
<li>Load an MRI scan into Python and explain how the data is stored</li>
<li>View and manipulate image data</li>
<li>Explain what BIDS is</li>
<li>Explain advantages of working with Nifti and BIDS</li>
<li>Show a method to convert from DICOM to BIDS/NIfTI</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h2>
<hr class="half-width"><p>When some programmers open their IDE, they type <code>pwd</code>
because this command allows you to see what directory you are in, and
then often they type <code>git branch</code> to see which branch they
are on. When many clinicians open an MRI they look at the anatomy, but
also figure out which sequence and type of MRI they are looking at. We
all need to begin with a vague idea of where in the world we are and
which direction we are facing, so to speak. As a digital researcher
orienting yourself in terms of MRIs and related computation is
important. In terms of computation MRIs, particularly neuro MRIs, have
some quirks that make it worthwhile to think of them as a separate part
of the universe than other medical imaging. Three critical differences
between MRIs and other medical imaging are image orientation in terms of
display conventions, typical file types and typical packages used for
processing. In this lesson we will cover these three issues.</p>
<p>As a researcher in general we recommend familiarizing yourself with
the various possible sequences of MRI. Some sequences are much more
suited to answer certain questions than others. Generally we could
divide MR techniques into structural e.g. T1, T2 and so on, functional,
diffusion, perfusion, angiographic techniques and spectroscopy. The
sequences you work with determining the shape of files to expect. As an
example of what you would expect for structural imaging a 3-D array is
the norm, but for diffusion imaging you have a 4D tensor plus .bval and
.bvec files.<br>
If you work directly with a radiology department you will usually get
DICOM files that contain whatever sequences were done. However if you
obtain images from elsewhere they may come in other formats.</p>
</section><section><h2 class="section-heading" id="file-formats">File formats<a class="anchor" aria-label="anchor" href="#file-formats"></a></h2>
<hr class="half-width"><p>From the MRI scanner, MRI images are initially collected and put in
the DICOM format but can be converted to other formats to make working
with the data easier. Some file formats can be converted to others, for
example NiFTIs or Analyze files can be converted to MINC, but not
conversions can not be made from all file formats in all directions.</p>
<div class="section level4">
<h4 id="common-mri-file-formats">Common MRI File Formats<a class="anchor" aria-label="anchor" href="#common-mri-file-formats"></a></h4>
<p>To understand common file formats please review the table on
neuroimaging file formats <a href="https://carpentries-incubator.github.io/SDC-BIDS-IntroMRI/instructor/scanner-to-computer.html#neuroimaging-file-formats-1" class="external-link">here.</a>
To get even more information than that table we have included links to
documentation websites:</p>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr class="header"><th>Format Name</th>
<th>More info</th>
</tr></thead><tbody><tr class="odd"><td>DICOM</td>
<td><a href="https://www.dicomstandard.org/" class="external-link uri">https://www.dicomstandard.org/</a></td>
</tr><tr class="even"><td>Analyze</td>
<td><a href="https://eeg.sourceforge.net/ANALYZE75.pdf" class="external-link uri">https://eeg.sourceforge.net/ANALYZE75.pdf</a></td>
</tr><tr class="odd"><td>NIfTI</td>
<td><a href="https://brainder.org/2012/09/23/the-nifti-file-format/" class="external-link uri">https://brainder.org/2012/09/23/the-nifti-file-format/</a></td>
</tr><tr class="even"><td>MINC</td>
<td><a href="https://www.mcgill.ca/bic/software/minc" class="external-link uri">https://www.mcgill.ca/bic/software/minc</a></td>
</tr><tr class="odd"><td>NRRD</td>
<td><a href="https://teem.sourceforge.net/nrrd/format.html" class="external-link uri">https://teem.sourceforge.net/nrrd/format.html</a></td>
</tr><tr class="even"><td>MGH</td>
<td><a href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/MghFormat" class="external-link uri">https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/MghFormat</a></td>
</tr></tbody></table><p>NIfTI is one of the most ubiquitous file formats for storing
neuroimaging data. We can convert DICOM data to NIfTI using <a href="https://github.com/rordenlab/dcm2niix" class="external-link">dcm2niix</a> software. Many
people prefer working with <code>dcm2bids</code> to configure long bash
commands needed for <code>dcm2niix</code>.</p>
<p>For example if you just want to write bash using dcm2niix or dcm2bids
to place a convert a hypothetical DICOM file (in a directory
/hypothetical) into a hypothetical directory called /converted on your
machine you can do it in the following way:</p>
<p><code>dcm2biids_helper -d /hypothetical -o /converted</code></p>
<p>One of the advantages of working with <code>dcm2niix</code>, whether
you work with it directly or with a tool like <code>dcm2bids</code> is
that it can be used to create Brain Imaging Data Structure (BIDS) files,
since it outputs a NIfTI and a JSON with metadata ready to fit into the
BIDS standard. <a href="https://bids.neuroimaging.io/" class="external-link">BIDS</a> is a
widely adopted standard of how data from neuroimaging research can be
organized. The organization of data and files is crucial for seamless
collaboration across research groups and even between individual
researchers. Some pipelines assume your data is organized in BIDS
structure, and these are sometimes called <a href="https://bids-apps.neuroimaging.io/apps/" class="external-link">BIDS Apps</a>.</p>
<p>Some of the more popular examples are:</p>
<ul><li><code>fmriprep</code></li>
<li><code>freesurfer</code></li>
<li><code>micapipe</code></li>
<li><code>SPM</code></li>
<li><code>MRtrix3_connectome</code></li>
</ul><p>We recommend the <a href="https://bids-standard.github.io/bids-starter-kit/#" class="external-link">BIDS
starter-kit website</a> for learning the basics of this standard.
Working with BIDS or and much of the array of tools available for brain
MRIs is often facilitated by some familiarity with writing command line.
This could present bit of a problem in terms of scientific
reproducibility. One option is to leave bash scripts and good
documentation in a repository. Another is to use a pythonic interface to
such command line tools. One possibility for this will be discussed in
the next section.</p>
</div>
</section><section><h2 class="section-heading" id="libraries">Libraries<a class="anchor" aria-label="anchor" href="#libraries"></a></h2>
<hr class="half-width"><p>If you look at python code for research on medical imaging of most of
the body, a few libraries, such as SITK, will pop up again and again.
The story with MRIs of the brain is entirely different. Most researchers
will use libraries like nibabel and related libraries. These libraries
are made to read, write, and manipulate neuroimaging file formats
efficiently. There is lots of code developed in them for the specific
tasks related to brain MRIs. They also tend to integrate better with
existing pipelines for brain MRI. nipype is a popular tool which
attempts to allow users to harness popular existing pipelines. If you
are trying to compare outputs with an existing study, it is worth
considering using the same pipeline and software version of the
pipeline. Then you know differences between your outcomes are not
artifacts of the softwares.</p>
<figure><img src="fig/nipreps-chart.png" alt="Nipreps chart" width="70%;" class="figure mx-auto d-block"></figure><p><em>Sourced from <a href="https://www.nipreps.org/" class="external-link">https://www.nipreps.org/</a></em></p>
<div id="nipreps-and-beyond" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="nipreps-and-beyond" class="callout-inner">
<h3 class="callout-title">Nipreps and Beyond:</h3>
<div class="callout-content">
<ul><li>There are many, many packages for medical image analysis</li>
<li>There are known pre-built pipelines with possibilities in
python</li>
<li>Your pipeline will probably begin with cleaning and preparing
data</li>
<li>You can mix and match parts of pipelines with NiPype</li>
</ul></div>
</div>
</div>
<p>While you may harness sophisticated tools like Freesurfer or FSL to
do complex tasks like segmentation and registration in ways that match
existing research, you should not avoid checking your data by hand. At
some point you should open images and examine them both in terms of the
imaging (which could be done with a pre-built viewer) and the
computational aspects like metadata and shape. For these mundane tasks
we recommend nibabel.</p>
<p>Next, we’ll cover some details on working with NIfTI files with
Nibabel.</p>
<div class="section level4">
<h4 id="reading-nifti-images">Reading NIfTI Images<a class="anchor" aria-label="anchor" href="#reading-nifti-images"></a></h4>
<p><a href="https://nipy.org/nibabel/" class="external-link">NiBabel</a> is a Python package
for reading and writing neuroimaging data. To learn more about how
NiBabel handles NIfTIs, refer to the <a href="https://nipy.org/nibabel/nifti_images.html" class="external-link">NiBabel documentation
on working with NIfTIs</a>, which this episode heavily references. This
part of the lesson is also similar to an existing lessons from The
Carpentries Incubator; namely: <a href="https://carpentries-incubator.github.io/SDC-BIDS-IntroMRI/" class="external-link">Introduction
to Working with MRI Data in Python</a>. This is because in terms of
reading and loading data and accessing the image, there are limited
possibilities.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span></code></pre>
</div>
<p>First, use the <code>load()</code> function to create a
<code>NiBabel</code> image object from a NIfTI file.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>t2_img <span class="op">=</span> nib.load(<span class="st">"data/mri//OBJECT_phantom_T2W_TSE_Cor_14_1.nii"</span>)</span></code></pre>
</div>
<p>When loading a NIfTI file with <code>NiBabel</code>, you get a
specialized data object that includes all the information stored in the
file. Each piece of information is referred to as an
<strong>attribute</strong> in Python’s terminology. To view all these
attributes, simply type <code>t2_img.</code> followed by <kbd>Tab</kbd>.
We will focus on discussing mainly two attributes (<code>header</code>
and <code>affine</code>) and one method (<code>get_fdata</code>).</p>
<div class="section level5">
<h5 id="headers">1. Headers<a class="anchor" aria-label="anchor" href="#headers"></a></h5>
<p><a href="https://nipy.org/nibabel/nibabel_images.html#the-image-header" class="external-link">The
header</a> contains metadata about the image, including image
dimensions, data type, and more.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>t2_hdr <span class="op">=</span> t2_img.header</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="bu">print</span>(t2_hdr)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;class 'nibabel.nifti1.Nifti1Header'&gt; object, endian='&lt;'
sizeof_hdr      : 348
data_type       : b''
db_name         : b''
extents         : 0
session_error   : 0
regular         : b''
dim_info        : 0
dim             : [  3 432 432  30   1   1   1   1]
intent_p1       : 0.0
intent_p2       : 0.0
intent_p3       : 0.0
intent_code     : none
datatype        : int16
bitpix          : 16
slice_start     : 0
pixdim          : [1.        0.9259259 0.9259259 5.7360578 0.        0.        0.
 0.       ]
vox_offset      : 0.0
scl_slope       : nan
scl_inter       : nan
slice_end       : 29
slice_code      : unknown
xyzt_units      : 2
cal_max         : 0.0
cal_min         : 0.0
slice_duration  : 0.0
toffset         : 0.0
glmax           : 0
glmin           : 0
descrip         : b'Philips Healthcare Ingenia 5.4.1 '
aux_file        : b''
qform_code      : scanner
sform_code      : unknown
quatern_b       : 0.008265011
quatern_c       : 0.7070585
quatern_d       : -0.7070585
qoffset_x       : 180.81993
qoffset_y       : 21.169691
qoffset_z       : 384.01007
srow_x          : [1. 0. 0. 0.]
srow_y          : [0. 1. 0. 0.]
srow_z          : [0. 0. 1. 0.]
intent_name     : b''
magic           : b'n+1'</code></pre>
</div>
<p><code>t2_hdr</code> is a Python <strong>dictionary</strong>, i.e. a
container that hold pairs of objects - keys and values. Let’s take a
look at all of the keys.</p>
<p>Similar to <code>t2_img</code>, in which attributes can be accessed
by typing <code>t2_img.</code> followed by <kbd>Tab</kbd>, you can do
the same with <code>t2_hdr</code>.</p>
<p>In particular, we’ll be using a <strong>method</strong> belonging to
<code>t2_hdr</code> that will allow you to view the keys associated with
it.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">print</span>(t2_hdr.keys())</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['sizeof_hdr',
 'data_type',
 'db_name',
 'extents',
 'session_error',
 'regular',
 'dim_info',
 'dim',
 'intent_p1',
 'intent_p2',
 'intent_p3',
 'intent_code',
 'datatype',
 'bitpix',
 'slice_start',
 'pixdim',
 'vox_offset',
 'scl_slope',
 'scl_inter',
 'slice_end',
 'slice_code',
 'xyzt_units',
 'cal_max',
 'cal_min',
 'slice_duration',
 'toffset',
 'glmax',
 'glmin',
 'descrip',
 'aux_file',
 'qform_code',
 'sform_code',
 'quatern_b',
 'quatern_c',
 'quatern_d',
 'qoffset_x',
 'qoffset_y',
 'qoffset_z',
 'srow_x',
 'srow_y',
 'srow_z',
 'intent_name',
 'magic']</code></pre>
</div>
<p>Notice that <strong>methods</strong> require you to include () at the
end of them when you call them whereas <strong>attributes</strong> do
not. The key difference between a method and an attribute is:</p>
<ul><li>Attributes are <em>variables</em> belonging to an object and
containing information about their properties or characteristics</li>
<li>Methods are functions that belong to an object and operate on its
attributes. They differ from regular functions by implicitly receiving
the object (<code>self</code>) as their first argument.</li>
</ul><p>When you type in <code>t2_img.</code> followed by <kbd>Tab</kbd>, you
may see that attributes are highlighted in orange and methods
highlighted in blue.</p>
<p>The output above is a list of <strong>keys</strong> you can use to
access <strong>values</strong> of <code>t2_hdr</code>. We can access the
value stored by a given key by typing:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="bu">print</span>(t2_hdr[<span class="st">'&lt;key_name&gt;'</span>])</span></code></pre>
</div>
<div id="challenge-extract-values-from-the-nifti-header" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-extract-values-from-the-nifti-header" class="callout-inner">
<h3 class="callout-title">Challenge: Extract Values from the NIfTI
Header</h3>
<div class="callout-content">
<p>Extract the ‘pixdim’ field from the NiFTI header of the loaded
image.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="bu">print</span>(t2_hdr[<span class="st">'pixdim'</span>])</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([1. , 0.9259259, 0.9259259, 5.7360578, 0. , 0. , 0. , 0. ], dtype=float32)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level5">
<h5 id="data">2. Data<a class="anchor" aria-label="anchor" href="#data"></a></h5>
<p>As you’ve seen above, the header contains useful information that
gives us information about the properties (metadata) associated with the
MR data we’ve loaded in. Now we’ll move in to loading the actual
<em>image data itself</em>. We can achieve this by using the method
called <code>t2_img.get_fdata()</code>:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>t2_data <span class="op">=</span> t2_img.get_fdata()</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="bu">print</span>(t2_data)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([[[0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        ...,
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.]],

       [[0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        ...,
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.]],

       ...,

       [[0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        ...,
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.],
        [0., 0., 0., ..., 0., 0., 0.]]])</code></pre>
</div>
<p>The initial observation you might make is the prevalence of zeros in
the image. This abundance of zeros might prompt concerns about the
presence of any discernible content in the picture. However, when
working with radiological images, it’s important to keep in mind that
these images frequently contain areas of air surrounding the objects of
interest, which appear as black space.</p>
<p>What type of data is this exactly in a computational sense? We can
determine this by calling the <code>type()</code> function on
<code>t2_data</code>:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(t2_data))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">numpy.ndarray</span></span></code></pre>
</div>
<p>The data is stored as a multidimensional <strong>array</strong>,
which can also be accessed through the file’s <code>dataobj</code>
property:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>t2_img.dataobj</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;nibabel.arrayproxy.ArrayProxy at 0x20c63b5a4a0&gt;</code></pre>
</div>
<p>As you might guess there are differences in how your computer handles
something made with dataobj and an actual array. These differences
effect memory and processing speed. These are not trivial issues if you
deal with a very large dataset of MRIs. You can save time and memory by
being conscious about what is cached and using the dataobj property when
dealing with slices of the array as detailed <a href="https://nipy.org/nibabel/images_and_memory.html" class="external-link">here</a></p>
<div id="challenge-meaning-of-attributes-of-the-array" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-meaning-of-attributes-of-the-array" class="callout-inner">
<h3 class="callout-title">Challenge: Meaning of Attributes of the
Array</h3>
<div class="callout-content">
<p>How can we see the number of dimensions in the <code>t2_data</code>
array? Once again, all of the attributes of the array can be seen by
typing <code>t2_data.</code> followed by <kbd>Tab</kbd>. What is the
shape of the image? Can you make a guess about then size of a voxel
based on the numbers you have here? Why or why not?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="bu">print</span>(t2_data.ndim)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">3</span></span></code></pre>
</div>
<p><code>t2_data</code> contains 3 dimensions. You can think of the data
as a 3D version of a picture (more accurately, a volume).</p>
<figure><img src="fig/3D_array_diagram.png" alt="Arrays" width="70%;" class="figure mx-auto d-block"></figure><p><em>Image by Tropwine, sourced from Wikimedia Commons
(2024).https://commons.m.wikimedia.org/wiki/<a href="File:3D_array_diagram.svg" class="uri">File:3D_array_diagram.svg</a>; Creative Commons Attribution
4.0 International License </em></p>
<p>Remember typical 2D pictures are made out of <strong>pixels</strong>,
but a 3D MR image is made up of 3D cubes called
<strong>voxels</strong>.</p>
<figure><img src="fig/pixel_vs_voxel.png" alt="MRI slices" width="70%;" class="figure mx-auto d-block"></figure><p><em>Sourced with minor modification from Ahmed, M., Garzanich, M.,
Melaragno, L.E. et al. Exploring CT pixel and voxel size effect on
anatomic modeling in mandibular reconstruction. 3D Print Med 10, 21
(2024). <a href="https://doi.org/10.1186/s41205-024-00223-0" class="external-link uri">https://doi.org/10.1186/s41205-024-00223-0</a>; Creative
Commons Attribution 4.0 International License </em></p>
<p>With this in mind we examine the shape:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="bu">print</span>(t2_data.shape)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(432, 432, 30)</code></pre>
</div>
<p>The three numbers given here represent the number of values <em>along
a respective dimension (x,y,z)</em>. This image was scanned in 30
slices, each with a resolution of 432 x 432 voxels. If each voxel were 1
millimeter, then our image would represent something 3cm tall (so to
speak), and this seems unlikely. However, object here is not human, and
could be in theory be scanned on a special MRI machine of any size. We
can not make a guess from the data we printed here alone about the size
of a voxel. We will learn one method to do this later in the
episode.</p>
</div>
</div>
</div>
</div>
<p>Let’s see the type of data inside of the array.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="bu">print</span>(t2_data.dtype)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fu">dtype</span><span class="op">(</span><span class="st">'float64'</span><span class="op">)</span></span></code></pre>
</div>
<p>This tells us that each element in the array (or voxel) is a
floating-point number.<br>
The data type of an image controls the range of possible intensities. As
the number of possible values increases, the amount of space the image
takes up in memory also increases.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">min</span>(t2_data))</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">max</span>(t2_data))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">0.0</span></span>
<span><span class="fl">630641.0785522461</span></span></code></pre>
</div>
<p>For our data, the range of intensity values goes from 0 (black) to
more positive digits (whiter).</p>
<p>To examine the value of a specific voxel, you can access it using its
indices. For example, if you have a 3D array <code>data</code>, you can
retrieve the value of a voxel at coordinates (x, y, z) with the
following syntax:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>value <span class="op">=</span> data[x, y, z]</span></code></pre>
</div>
<p>This will give you the value stored at the voxel located at the
specified index <code>(x, y, z)</code>. Make sure that the indices are
within the bounds of the array dimensions.</p>
<p>To inspect the value of a voxel at coordinates (9, 19, 2), you can
use the following code:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="bu">print</span>(t2_data[<span class="dv">9</span>, <span class="dv">19</span>, <span class="dv">2</span>])</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">0.</span></span></code></pre>
</div>
<p>This command retrieves and prints the intensity value at the
specified voxel. The output represents the signal intensity at that
particular location.</p>
<p>Next, we will explore how to extract and visualize larger regions of
interest, such as slices or arrays of voxels, for more comprehensive
analysis.</p>
</div>
</div>
<div class="section level4">
<h4 id="working-with-image-data">Working with Image Data<a class="anchor" aria-label="anchor" href="#working-with-image-data"></a></h4>
<p>When we think and speak about about “slicing” colloqiually, we often
think about a 2D <strong>slice</strong> from our data.</p>
<figure><img src="fig/slices2.png" alt="T1 weighted" class="figure mx-auto d-block"></figure><p><em>Figure with adaptation from Valdes-Hernandez, P.A., Laffitte
Nodarse, C., Peraza, J.A. et al. Toward MR protocol-agnostic, unbiased
brain age predicted from clinical-grade MRIs. Sci Rep 13, 19570 (2023).
<a href="https://doi.org/10.1038/s41598-023-47021-y" class="external-link uri">https://doi.org/10.1038/s41598-023-47021-y</a> ; Creative
Commons Attribution 4.0 International License</em></p>
<p>From left to right: coronal, saggital and axial slices of a
brain.</p>
<p>Let’s select the 10th slice in the z-axis of our data:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>z_slice <span class="op">=</span> t2_data[:, :, <span class="dv">9</span>]</span></code></pre>
</div>
<p>This is similar to the indexing we did before to select a single
voxel. However, instead of providing a value for each axis, the
<code>:</code> indicates that we want to grab <em>all</em> values from
that particular axis.</p>
<p>In the nibabel documentation there are more details on how to use a
<code>slicer</code> attribute of a nibabel array data. Using this
attribute can help to make code more efficient.</p>
<div id="challenge-slicing-mri-data" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-slicing-mri-data" class="callout-inner">
<h3 class="callout-title">Challenge: Slicing MRI Data</h3>
<div class="callout-content">
<p>Write a python function using nibabel to take an image string, and
coordinates for any slices desired on x, y and z axes; and plot the
image slices. Then use the function to display slices of
<code>t2_data</code> at x = 9, y = 9, and z= 9.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># if in a new notebook re-import</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="kw">def</span> slice_image_data(file_path, x, y, z):</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>    <span class="co"># load the image</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>        img <span class="op">=</span> nib.load(file_path)</span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error loading the image: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>    <span class="co"># get the image array</span></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a>    data <span class="op">=</span> img.get_fdata()</span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a>    <span class="co"># slice the image data</span></span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a>    <span class="co"># and extract a specific slice along each plane</span></span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a>    z_slice <span class="op">=</span> data[:, :, z]  <span class="co"># slice</span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>    y_slice <span class="op">=</span> data[:, y, :]  <span class="co"># slice</span></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>    x_slice <span class="op">=</span> data[x, :, :]  <span class="co"># slice</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a>    <span class="co"># make each slice is 2D by explicitly removing unnecessary dimensions</span></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a>    z_slice <span class="op">=</span> z_slice.squeeze()  <span class="co"># this ensures it's a 2D array</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>    y_slice <span class="op">=</span> y_slice.squeeze()  </span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a>    x_slice <span class="op">=</span> x_slice.squeeze()  </span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>    </span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>    <span class="bu">print</span>(z_slice.shape)</span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a>    <span class="co"># visualize the slices</span></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a>    <span class="co"># plot the z slice</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>    plt.imshow(z_slice.T, cmap<span class="op">=</span><span class="st">'gray'</span>, origin<span class="op">=</span><span class="st">'lower'</span>)</span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a>    plt.title(<span class="st">'Z Slice'</span>)</span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>    <span class="co"># plot the y slice</span></span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a>    plt.imshow(y_slice.T, cmap<span class="op">=</span><span class="st">'gray'</span>, origin<span class="op">=</span><span class="st">'lower'</span>)</span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a>    plt.title(<span class="st">'Y Slice'</span>)</span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a>    <span class="co"># plot the x slice</span></span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb28-47"><a href="#cb28-47" tabindex="-1"></a>    plt.imshow(x_slice.T, cmap<span class="op">=</span><span class="st">'gray'</span>, origin<span class="op">=</span><span class="st">'lower'</span>)</span>
<span id="cb28-48"><a href="#cb28-48" tabindex="-1"></a>    plt.title(<span class="st">'X Slice'</span>)</span>
<span id="cb28-49"><a href="#cb28-49" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb28-50"><a href="#cb28-50" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" tabindex="-1"></a>slice_image_data(<span class="st">'data/mri//OBJECT_phantom_T2W_TSE_Cor_14_1.nii'</span>,<span class="dv">9</span>,<span class="dv">9</span>,<span class="dv">9</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>In the above exercise you may note many solutions do not return
anything. This is not unusal in Python when we only want a graph or
visualization. We really only want an artifact of some functions,
however we could return the artifact with more code if needed.</p>
<p>We’ve been slicing and dicing images but we have no idea what they
look like in a more global sense. In the next section we’ll show you one
way you can visualize it all together.</p>
</div>
<div class="section level4">
<h4 id="visualizing-the-data">Visualizing the Data<a class="anchor" aria-label="anchor" href="#visualizing-the-data"></a></h4>
<p>We previously inspected the signal intensity of the voxel at
coordinates (10,20,3).</p>
<p>We could look at the whole image at once by using a viewer. We can
even use code to make a viewer.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="im">import</span> ipywidgets <span class="im">as</span> widget</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="im">import</span> importlib</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="kw">class</span> NiftiSliceViewer:</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co">    A class to examine slices of MRIs, which are in Nifti Format. Similar code appears</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="co">    in several open source liberally licensed libraries written by drcandacemakedamoore </span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, volume_str, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>)):</span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>        <span class="va">self</span>.nifti <span class="op">=</span> nib.load(volume_str)</span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a>        <span class="va">self</span>.volume <span class="op">=</span> <span class="va">self</span>.nifti.get_fdata()</span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a>        <span class="va">self</span>.figsize <span class="op">=</span> figsize</span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>        <span class="va">self</span>.v <span class="op">=</span> [np.<span class="bu">min</span>(<span class="va">self</span>.volume), np.<span class="bu">max</span>(<span class="va">self</span>.volume)]</span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>        <span class="va">self</span>.widgets <span class="op">=</span> importlib.import_module(<span class="st">'ipywidgets'</span>)</span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>        <span class="va">self</span>.widgets.interact(<span class="va">self</span>.transpose, view<span class="op">=</span><span class="va">self</span>.widgets.Dropdown(</span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>            options<span class="op">=</span>[<span class="st">'axial'</span>, <span class="st">'saggital'</span>, <span class="st">'coronal'</span>],</span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>            value<span class="op">=</span><span class="st">'axial'</span>,</span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>            description<span class="op">=</span><span class="st">'View:'</span>,</span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>            disabled<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a>    <span class="kw">def</span> transpose(<span class="va">self</span>, view):</span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a>        <span class="co"># transpose the image to orient according to the slice plane selection</span></span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a>        orient <span class="op">=</span> {<span class="st">"saggital"</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>], <span class="st">"coronal"</span>: [<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>], <span class="st">"axial"</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]}</span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>        <span class="va">self</span>.vol <span class="op">=</span> np.transpose(<span class="va">self</span>.volume, orient[view])</span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a>        maxZ <span class="op">=</span> <span class="va">self</span>.vol.shape[<span class="dv">2</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a>        <span class="va">self</span>.widgets.interact(</span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a>            <span class="va">self</span>.plot_slice,</span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a>            z<span class="op">=</span><span class="va">self</span>.widgets.IntSlider(</span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a>                <span class="bu">min</span><span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a>                <span class="bu">max</span><span class="op">=</span>maxZ,</span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a>                step<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a>                continuous_update<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a>                description<span class="op">=</span><span class="st">'Image Slice:'</span></span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a>            ),</span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a>        )</span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a>    <span class="kw">def</span> plot_slice(<span class="va">self</span>, z):</span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a>        <span class="co"># plot slice for plane which will match the widget intput</span></span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a>        <span class="va">self</span>.fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span><span class="va">self</span>.figsize)</span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a>        plt.imshow(</span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a>            <span class="va">self</span>.vol[:, :, z],</span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"gray"</span>,</span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a>            vmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a>            vmax<span class="op">=</span><span class="va">self</span>.v[<span class="dv">1</span>],</span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a>        )</span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a><span class="co"># now we wil use our class on our image        </span></span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a>NiftiSliceViewer(<span class="st">'data/mri//OBJECT_phantom_T2W_TSE_Cor_14_1.nii'</span>)</span></code></pre>
</div>
<p>Notice our viewer has axial, saggital and coronal slices. These are
anatomical terms that allow us to make some assumptions about where
things are in space if we assume the patient went into the machine in a
certain way. When we look at an abstract image, these terms have little
meaning, but let’s take a look at a head.</p>
<div id="challenge-understanding-anatomical-terms-for-brains" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-understanding-anatomical-terms-for-brains" class="callout-inner">
<h3 class="callout-title">Challenge: Understanding anatomical terms for
brains</h3>
<div class="callout-content">
<p>Use the internet to read at least two sources on the meaning of the
terms axial, coronal and saggital. Write definitions for axial, saggital
and coronal in terms of how they slice up the head at the eyes in your
own words.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>Axial: Slices the head as if slicing across both eyes, such that
there is a slice between higher and lower levels Saggital: Slicing
between or on the side of the eyes, such that there is a slice between
more left and more right Coronal: Slicing both eyes such that there is a
slice between front and back levels</p>
</div>
</div>
</div>
</div>
<p>This brings us to the final crucial attribute of a NIfTI we will
discuss: affine.</p>
<div class="section level5">
<h5 id="affine">3. Affine<a class="anchor" aria-label="anchor" href="#affine"></a></h5>
<p>The final important piece of metadata associated with an image file
is the <strong>affine matrix</strong>, which indicates the position of
the image array data in the reference space. By reference space we
usually mean a predefined system mapping to real world space if we are
talking about real patient data.</p>
<p>Below is the affine matrix for our data:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>t2_affine <span class="op">=</span> t2_img.affine</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="bu">print</span>(t2_affine)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([[-9.25672975e-01,  2.16410652e-02, -1.74031337e-05,
         1.80819931e+02],
       [ 2.80924864e-06, -3.28338569e-08, -5.73605776e+00,
         2.11696911e+01],
       [-2.16410652e-02, -9.25672975e-01, -2.03403855e-07,
         3.84010071e+02],
       [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
         1.00000000e+00]])</code></pre>
</div>
<p>To explain this concept, recall that we referred to coordinates in
our data as (x,y,z) coordinates such that:</p>
<ul><li>x is the first dimension of <code>t2_data</code>
</li>
<li>y is the second dimension of <code>t2_data</code>
</li>
<li>z is the third dimension of <code>t2_data</code>
</li>
</ul><p>Although this tells us how to access our data in terms of voxels in a
3D volume, it doesn’t tell us much about the actual dimensions in our
data (centimetres, right or left, up or down, back or front). The affine
matrix allows us to translate between <em>voxel coordinates</em> in
(x,y,z) and <em>world space coordinates</em> in (left/right, bottom/top,
back/front). An important thing to note is that in reality in which
order you have:</p>
<ul><li>Left/right</li>
<li>Bottom/top</li>
<li>Back/front</li>
</ul><p>Depends on how you’ve constructed the affine matrix; thankfully there
is in depth coverage of the issue <a href="https://nipy.org/nibabel/coordinate_systems.html" class="external-link">the nibabel
documentation</a> For most of the the data we’re dealing with we use a
RAS coordinate system so it always refers to:</p>
<ul><li>Right</li>
<li>Anterior</li>
<li>Superior</li>
</ul><p>Increasing a coordinate value in the first dimension corresponds to
moving to the right of the person being scanned, and so on. In the real
world whatever orientation you put something in may make someone
unhappy. Luckily you can quickly change arrays around in terms of
direction by simply using an already efficient numpy functions. Two
functions in numpy that can be generalized to make any orientation of an
image are numpy.flip() and numpy.rot90(), however there are other
functions which are quite convenient for 2D arrays, as displayed
below.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>slices <span class="op">=</span> [z_slice, np.fliplr(z_slice), np.flipud(z_slice)]</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(slices))</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a><span class="cf">for</span> i, <span class="bu">slice</span> <span class="kw">in</span> <span class="bu">enumerate</span>(slices):</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>    axes[i].imshow(<span class="bu">slice</span>, cmap<span class="op">=</span><span class="st">"gray"</span>, origin<span class="op">=</span><span class="st">"lower"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code></code></pre>
</div>
<figure><img src="fig/flipper.png" alt="flipped images" width="70%;" class="figure mx-auto d-block"></figure><p>This brings us to a final difference we must account for when we
discuss neuro-MRIs: anatomy and visualization conventions.</p>
</div>
</div>
</section><section><h2 class="section-heading" id="display-conventions">Display conventions<a class="anchor" aria-label="anchor" href="#display-conventions"></a></h2>
<hr class="half-width"><p>When we describe imaging of any part of the body except the brain, as
professionals we all agree on certain conventions. We rely on anatomical
position as the basis of how we orient ourselves, and we expect the
patient’s right side to be on the left of our screen, and certain other
convensions. In terms of brain MRIs, this is less true; there is a
split. The issue is extremely well summarized in the <a href="https://nipy.org/nibabel/neuro_radio_conventions.html" class="external-link">nibabel
documentation on radiological versus neurological conventions</a>.</p>
</section><section><h2 class="section-heading" id="mri-processing-in-python">MRI processing in Python<a class="anchor" aria-label="anchor" href="#mri-processing-in-python"></a></h2>
<hr class="half-width"><p>To get a deeper view of MRI processing in Python you can explore
lessons from Carpentries Incubators; namely:</p>
<ol style="list-style-type: decimal"><li><a href="https://carpentries-incubator.github.io/SDC-BIDS-IntroMRI/" class="external-link">Introduction
to Working with MRI Data in Python</a></li>
<li><a href="https://carpentries-incubator.github.io/SDC-BIDS-sMRI/" class="external-link">Introduction
to Structural MRI</a></li>
<li><a href="https://carpentries-incubator.github.io/SDC-BIDS-dMRI/" class="external-link">Introduction
to dMRI</a></li>
<li><a href="https://carpentries-incubator.github.io/SDC-BIDS-fMRI/" class="external-link">Functional
Neuroimaging Analysis in Python</a></li>
</ol><!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 --></section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="medical_imaging.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="simpleitk.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="medical_imaging.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Medical Imaging
        </a>
        <a class="chapter-link float-end" href="simpleitk.html" rel="next">
          Next: Registration and...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/esciencecenter-digital-skills/medical-image-processing/edit/main/episodes/mri.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/esciencecenter-digital-skills/medical-image-processing/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/esciencecenter-digital-skills/medical-image-processing/" class="external-link">Source</a></p>
				<p><a href="https://github.com/esciencecenter-digital-skills/medical-image-processing/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:doctormakeda@gmail.com">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://esciencecenter-digital-skills.github.io/medical-image-processing/mri.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "python, software, lesson, medical images, DICOMs",
  "name": "Working with MRI",
  "creativeWorkStatus": "active",
  "url": "https://esciencecenter-digital-skills.github.io/medical-image-processing/mri.html",
  "identifier": "https://esciencecenter-digital-skills.github.io/medical-image-processing/mri.html",
  "dateCreated": "2024-12-29",
  "dateModified": "2024-12-29",
  "datePublished": "2025-02-04"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

